<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scorekeeper Live</title>
    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --accent: #4CAF50; --gold: #FFD700; --text: #ffffff; --text-secondary: #aaaaaa; --danger: #ff5252; --dealer-color: #2196F3; --radius: 12px; }
        body { font-family: sans-serif; background-color: var(--bg-color); color: var(--text); padding: 15px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.5); margin-bottom: 20px; transition: all 0.3s ease; }
        
        /* Inputs & Buttons */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #333; border-radius: 8px; color: white; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        button { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        button:active { transform: scale(0.98); }
        button.secondary { background: #444; }
        button.danger { background: var(--danger); }

        /* Typography */
        h1, h2, h3 { text-align: center; margin-top: 0; }
        .code-display { font-size: 2.5rem; letter-spacing: 5px; font-family: monospace; color: var(--accent); text-align: center; margin: 10px 0; font-weight: bold; }
        .info-text { text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; }

        /* Player List Styles */
        .player-row { background: #2c2c2c; padding: 10px; border-radius: 8px; display: grid; grid-template-columns: 30px 1fr auto 50px; align-items: center; gap: 10px; border-left: 4px solid transparent; margin-bottom: 8px; }
        .player-row.is-leader { border-left: 4px solid var(--gold); background: #2a2a1e; }
        .player-row.current-user { border: 1px solid var(--accent); }
        
        .rank-badge { background: #444; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 0.75rem; font-weight: bold; }
        .is-leader .rank-badge { background: var(--gold); color: #000; }
        
        .score-input { text-align: center; background: #111; border: 1px solid #444; width: 60px; padding: 8px; font-size: 1.1rem; }
        .total-score { font-weight: bold; font-size: 1.1rem; min-width: 30px; text-align: right; }
        
        .dealer-icon { width: 20px; height: 20px; background: var(--dealer-color); border-radius: 50%; color: white; font-size: 10px; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .player-row.is-dealer .dealer-icon { opacity: 1; }

        /* Views Utility */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #qr-container { display: flex; justify-content: center; margin: 15px 0; }
        #qr-container img { border-radius: 8px; border: 4px solid white; }
        
        .stats-card { background: #2c2c2c; padding: 15px; margin-bottom: 10px; border-radius: 8px; text-align: center; }
        .stats-val { font-size: 1.5rem; color: var(--gold); font-weight: bold; }
    </style>
</head>
<body>

    <div id="view-login" class="container view active">
        <h1>Scorekeeper Live</h1>
        <input type="text" id="inp-name" placeholder="Dein Name" maxlength="12">
        <div style="height: 20px;"></div>
        <button onclick="createGame()">Neues Spiel erstellen</button>
        <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
            <div style="flex:1; height: 1px; background: #333;"></div>
            <span style="color: #666; font-size: 0.8rem;">ODER</span>
            <div style="flex:1; height: 1px; background: #333;"></div>
        </div>
        <input type="text" id="inp-code" placeholder="Raum-Code (z.B. ABCD)" style="margin-top: 15px; text-transform: uppercase;">
        <button class="secondary" onclick="joinGame()">Beitreten</button>
    </div>

    <div id="view-lobby" class="container view">
        <h2>Lobby</h2>
        <div class="info-text">Teile den Code oder lass scannen:</div>
        <div class="code-display" id="lobby-code">ABCD</div>
        <div id="qr-container"></div>
        
        <div id="lobby-list" style="margin-top: 20px;"></div>

        <button id="btn-start" onclick="startGame()" style="display: none;">Spiel starten</button>
        <div id="wait-msg" class="info-text" style="margin-top: 20px;">Warte auf Host...</div>
    </div>

    <div id="view-game" class="container view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 id="round-display" style="margin:0;">Runde 1</h2>
            <div style="font-size: 0.8rem; background: #333; padding: 5px 10px; border-radius: 15px;">Code: <span id="game-code-display"></span></div>
        </div>
        
        <div id="game-list"></div>

        <button onclick="submitRound()">Runde eintragen</button>
        <button class="danger" id="btn-end" onclick="finishGame()" style="margin-top: 20px; display: none; font-size: 0.8rem; padding: 10px;">Spiel beenden & Auswerten</button>
    </div>

    <div id="view-stats" class="container view">
        <h1>Spielende!</h1>
        <div id="stats-content"></div>
        <div id="host-controls" style="display:none">
            <button onclick="restartGame()">Neustart (Gleiche Spieler)</button>
        </div>
        <button class="secondary" onclick="location.reload()">Zum Hauptmen√º</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentRoom = null;
        
        // --- 1. REJOIN & IDENTITY LOGIC ---
        // Wir generieren eine ID im Browser und speichern sie.
        // So erkennt der Server uns wieder, auch wenn wir F5 dr√ºcken.
        let myPermanentId = localStorage.getItem('scorekeeper_uid');
        if (!myPermanentId) {
            myPermanentId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('scorekeeper_uid', myPermanentId);
        }

        // Alten Namen laden
        const savedName = localStorage.getItem('scorekeeper_name');
        if (savedName) document.getElementById('inp-name').value = savedName;

        // Auto-Fill Code via URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('room')) {
            document.getElementById('inp-code').value = urlParams.get('room');
        }

        // --- NAVIGATION ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        // --- USER ACTIONS ---
        function createGame() {
            const name = document.getElementById('inp-name').value.trim();
            if (!name) return alert('Bitte Namen eingeben');
            localStorage.setItem('scorekeeper_name', name);
            
            socket.emit('createGame', { hostName: name, userId: myPermanentId });
        }

        function joinGame() {
            const name = document.getElementById('inp-name').value.trim();
            const code = document.getElementById('inp-code').value.trim();
            if (!name || !code) return alert('Name und Code erforderlich');
            
            localStorage.setItem('scorekeeper_name', name);
            socket.emit('joinGame', { 
                roomCode: code, 
                playerName: name, 
                userId: myPermanentId 
            });
        }

        function startGame() {
            socket.emit('startGame', currentRoom.code);
        }

        function submitRound() {
            const inputs = document.querySelectorAll('.score-input');
            const scores = {};
            let zeroCount = 0;

            inputs.forEach(input => {
                const pid = input.dataset.pid;
                const val = input.value;
                scores[pid] = val; 

                if (val === '' || val === '0') zeroCount++;
            });

            // Vorab-Check Client
            if (zeroCount > 1) {
                alert('Regel: Maximal eine "0" (oder leeres Feld) pro Runde!');
                return;
            }

            socket.emit('submitRound', { roomCode: currentRoom.code, roundScores: scores });
        }

        function finishGame() {
            if(confirm("Spiel wirklich beenden?")) {
                socket.emit('finishGame', currentRoom.code);
            }
        }

        function restartGame() {
            socket.emit('restartGame', currentRoom.code);
        }

        // --- SOCKET EVENTS ---
        socket.on('connect', () => {
            // Falls wir gerade neu geladen haben und noch wissen, in welchem Raum wir waren:
            // (Optional: Man k√∂nnte hier einen automatischen Rejoin versuchen, 
            // aber wir lassen den User lieber "Beitreten" klicken oder nutzen den State vom Server)
        });

        socket.on('gameCreated', ({ roomCode, qrCodeData }) => {
            document.getElementById('lobby-code').innerText = roomCode;
            const img = document.createElement('img');
            img.src = qrCodeData;
            document.getElementById('qr-container').innerHTML = '';
            document.getElementById('qr-container').appendChild(img);
        });

        socket.on('errorMsg', (msg) => alert(msg));

        socket.on('gameState', (room) => {
            currentRoom = room;
            
            // Bin ich der Host? (Vergleich Permanent-ID)
            const isHost = (room.hostUserId === myPermanentId);
            
            // Buttons steuern
            document.getElementById('btn-start').style.display = isHost ? 'block' : 'none';
            document.getElementById('wait-msg').style.display = isHost ? 'none' : 'block';
            document.getElementById('btn-end').style.display = isHost ? 'block' : 'none';
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';

            // View wechseln
            if (room.status === 'lobby') {
                showView('view-lobby');
                renderLobby(room.players);
            } else if (room.status === 'playing') {
                showView('view-game');
                renderGame(room);
            } else if (room.status === 'finished') {
                showView('view-stats');
                renderStats(room);
            }
        });

        // --- RENDER FUNKTIONEN ---

        function renderLobby(players) {
            const list = document.getElementById('lobby-list');
            list.innerHTML = players.map(p => `
                <div class="player-row ${p.userId === myPermanentId ? 'current-user' : ''}">
                    <div class="rank-badge" style="background:#555">‚óè</div>
                    <div>${p.name}</div>
                    <div></div>
                </div>
            `).join('');
            document.getElementById('lobby-code').innerText = currentRoom.code;
        }

        function renderGame(room) {
            document.getElementById('round-display').innerText = `Runde ${room.round}`;
            document.getElementById('game-code-display').innerText = room.code;

            // Sortierung f√ºr Anzeige (Wer f√ºhrt? Wenigste Punkte)
            const sortedPlayers = [...room.players].sort((a, b) => a.total - b.total);
            const leaderId = sortedPlayers[0]?.userId; 

            // Dealer rotiert
            const dealerIndex = (room.round - 1) % room.players.length;
            // Wir m√ºssen den Dealer basierend auf der originalen Array-Reihenfolge finden, nicht der sortierten
            const dealerId = room.players[dealerIndex]?.userId;

            const list = document.getElementById('game-list');
            
            // Wir rendern die Liste in der Reihenfolge des Punktestands (Golf-Style)
            list.innerHTML = sortedPlayers.map((p, index) => {
                const rank = index + 1;
                const isLeader = (p.userId === leaderId);
                const isDealer = (p.userId === dealerId);
                const isMe = (p.userId === myPermanentId);
                
                return `
                <div class="player-row ${isLeader ? 'is-leader' : ''} ${isDealer ? 'is-dealer' : ''} ${isMe ? 'current-user' : ''}">
                    <div class="rank-badge">${rank}</div>
                    <div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        ${p.name}
                        <div class="dealer-icon">D</div>
                    </div>
                    <div class="total-score">${p.total}</div>
                    <input type="number" pattern="[0-9]*" class="score-input" data-pid="${p.id}" placeholder="-">
                </div>
                `;
            }).join('');
        }

        function renderStats(room) {
            const players = [...room.players].sort((a, b) => a.total - b.total);
            const winner = players[0];
            const loser = players[players.length - 1];

            let mostZerosPlayer = null;
            let maxZeros = -1;
            
            players.forEach(p => {
                const zeros = p.scores.filter(s => s === 0).length;
                if(zeros > maxZeros) {
                    maxZeros = zeros;
                    mostZerosPlayer = p;
                }
            });

            let html = `
                <div class="stats-card" style="border: 2px solid var(--gold)">
                    <div>üèÜ Gewinner</div>
                    <div class="stats-val">${winner.name}</div>
                    <div>${winner.total} Punkte</div>
                </div>
                <div class="stats-card">
                    <div>üìâ Letzter Platz</div>
                    <div class="stats-val" style="color: var(--danger)">${loser.name}</div>
                    <div>${loser.total} Punkte</div>
                </div>
            `;

            if(maxZeros > 0) {
                html += `
                <div class="stats-card">
                    <div>‚≠ï Zero King</div>
                    <div class="stats-val" style="color: var(--accent)">${mostZerosPlayer.name}</div>
                    <div>${maxZeros}x Null</div>
                </div>`;
            }

            document.getElementById('stats-content').innerHTML = html;
        }
    </script>
</body>
</html>